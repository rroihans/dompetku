# Spec: Data Integrity & Automation Fixes (2026-01-02)

## Overview
This track focuses on improving the reliability of financial data and automation within Dompetku. We aim to ensure that Net Worth history is always accurate, transaction running balances are stable, and recurring bills are never duplicated, all while maintaining high application performance.

## Functional Requirements

### 1. Optimized Real-time Net Worth Snapshots
- **Trigger:** Every time a transaction is created, updated, or deleted via server actions, a call to `saveNetWorthSnapshot()` is triggered.
- **Performance Optimization:** 
    - The snapshot update must be **non-blocking**. The main transaction response should not wait for the snapshot calculation to complete before returning to the user.
    - Use "Upsert" logic: If a snapshot for the current date (YYYY-MM-DD) already exists, update the existing record instead of creating a new one.
- **Goal:** Ensure the "Net Worth Trend" chart reflects the latest balances with minimal latency.

### 2. Stable Running Balance Calculation
- **Logic Refinement:** In `getTransaksi`, the backward calculation from the current balance must be stabilized.
- **Ordering:** Apply a secondary sort by `id` (descending) in addition to `tanggal` (descending) to ensure that multiple transactions on the same day are processed in a deterministic order for the running balance display.
- **Database Optimization:** Ensure the `id` and `tanggal` columns are indexed to keep the calculation fast even with thousands of transactions.

### 3. Recurring Bill Idempotency
- **Key Generation:** Implement a unique `idempotencyKey` for transactions generated by the recurring bill engine.
- **Format:** `recurring_{recurringRuleId}_{YYYY-MM-DD}`.
- **Enforcement:** Use the database `UNIQUE` constraint on `idempotencyKey` to prevent duplicate entries at the engine level.

## Acceptance Criteria
- [ ] Adding a transaction immediately reflects in the Net Worth snapshot for today.
- [ ] Transaction creation time (UI latency) remains under 200ms despite the snapshot trigger.
- [ ] In the Transaction History for a specific account, the "Running Balance" remains consistent even for transactions sharing the same date.
- [ ] Running the `generate-recurring` logic twice for the same day results in only one set of transactions being created.

## Non-Functional Requirements
- **Efficiency:** Minimize database queries during snapshot generation by using a single aggregate query for account balances.
- **Consistency:** Use Indonesian for all log messages related to these fixes.

## Out of Scope
- Visual polish of charts or category icons.
- CSV/Excel export functionality.
