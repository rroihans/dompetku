datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. Tabel Akun: Untuk menyimpan Bank, E-Wallet, Kartu Kredit, dll.
model Akun {
  id                String            @id @default(cuid())
  nama              String            // Contoh: "BCA Tahapan", "Kartu Kredit Jenius"
  tipe              String            // BANK, E_WALLET, CREDIT_CARD, CASH, EXPENSE, INCOME (SQLite use string)
  saldoAwal         Float             @default(0)
  saldoSekarang     Float             @default(0)
  limitKredit       Float?            // Khusus untuk Kartu Kredit
  icon              String?           // URL atau nama icon Lucide
  warna             String?           // Hex code untuk identitas visual di UI
  
  // Fitur Automasi (v0.4.0)
  templateId        String?
  template          AccountTemplate?  @relation(fields: [templateId], references: [id])
  setoranAwal       Float?            // Track biaya setup/setoran awal
  lastAdminChargeDate DateTime?       // Tanggal terakhir biaya admin ditarik
  lastInterestCreditDate DateTime?    // Tanggal terakhir bunga dikreditkan

  // Relasi Pembukuan Berpasangan
  transaksiDebit    Transaksi[]       @relation("DebitRelation")
  transaksiKredit   Transaksi[]       @relation("KreditRelation")

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("akun")
}

// 1.1 Tabel AccountTemplate: Definisi biaya admin dan bunga perbankan (v0.4.0)
model AccountTemplate {
  id                String            @id @default(cuid())
  nama              String            // Contoh: "BCA Tahapan Xpresi"
  tipeAkun          String            // BANK, E_WALLET, dll
  biayaAdmin        Float?            // Nominal biaya admin bulanan
  bungaTier         String?           // JSON: [{min_saldo: 0, max_saldo: 999999, bunga_pa: 0}, ...]
  
  polaTagihan       String            // TANGGAL_TETAP, JUMAT_MINGGU_KETIGA, HARI_KERJA_TERAKHIR
  tanggalTagihan    Int?              // 1-31 (untuk TANGGAL_TETAP)
  
  deskripsi         String?           @default("")
  isActive          Boolean           @default(true)
  
  akun              Akun[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("account_template")
}

// 2. Tabel Transaksi: Jantung dari aplikasi (General Ledger)
model Transaksi {
  id                String            @id @default(cuid())
  tanggal           DateTime          @default(now())
  deskripsi         String
  nominal           Float             // Nominal utama
  kategori          String            // Contoh: Makan, Transport, Cicilan
  
  // Logika Double-Entry
  debitAkunId       String            // Akun yang bertambah (misal: Pengeluaran_Makan)
  kreditAkunId      String            // Akun yang berkurang (misal: Bank_BCA)
  debitAkun         Akun              @relation("DebitRelation", fields: [debitAkunId], references: [id])
  kreditAkun        Akun              @relation("KreditRelation", fields: [kreditAkunId], references: [id])

  // Opsional: Untuk menghubungkan dengan Cicilan
  rencanaCicilanId  String?
  rencanaCicilan    RencanaCicilan?   @relation(fields: [rencanaCicilanId], references: [id])

  // Metadata untuk Troubleshooting & Audit
  idempotencyKey    String?           @unique // Mencegah duplikasi input
  catatan           String?           // Catatan tambahan manual
  createdAt         DateTime          @default(now())

  @@index([tanggal, id])
  @@index([kategori])
  @@index([debitAkunId])
  @@index([kreditAkunId])
  @@map("transaksi")
}

// 3. Tabel Rencana Cicilan: Mesin otomatisasi untuk Kartu Kredit
model RencanaCicilan {
  id                String            @id @default(cuid())
  namaProduk        String            // Contoh: "iPhone 15 Pro"
  totalPokok        Float             // Harga barang asli
  tenor             Int               // Jumlah bulan (misal: 12)
  cicilanKe         Int               @default(1)
  nominalPerBulan   Float             // Pokok + Bunga yang ditagih per bulan
  biayaAdmin        Float             @default(0)
  bungaPersen       Float             @default(0)
  tanggalJatuhTempo Int               // Tanggal 1-31 setiap bulan
  
  status            String            @default("AKTIF") // AKTIF, LUNAS, DIBALIKKAN
  
  // Akun sumber dan tujuan untuk otomatisasi
  akunKreditId      String            // Akun kartu kredit yang terpotong
  akunDebitId       String            // Akun pengeluaran cicilan
  
  transaksi         Transaksi[]       // Histori transaksi yang sudah di-generate

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("rencana_cicilan")
}

// 4. Tabel Log Sistem: Untuk troubleshooting (Audit Trail)
model LogSistem {
  id                String            @id @default(cuid())
  level             String            // INFO, WARN, ERROR
  modul             String            // AUTH, TRANSACTION, SYNC
  pesan             String
  stackTrace        String?           // Jika error, simpan detailnya di sini
  createdAt         DateTime          @default(now())

  @@map("log_sistem")
}

// 5. Tabel Budget: Anggaran per kategori
model Budget {
  id                String            @id @default(cuid())
  kategori          String            // Kategori pengeluaran
  bulan             Int               // 1-12
  tahun             Int               // 2024, 2025, etc
  nominal           Float             // Limit anggaran
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([kategori, bulan, tahun])
  @@map("budget")
}

// 6. Tabel Recurring Transaction: Transaksi berulang otomatis
model RecurringTransaction {
  id                String            @id @default(cuid())
  nama              String            // Nama transaksi berulang
  nominal           Float
  kategori          String
  tipeTransaksi     String            // KELUAR atau MASUK
  
  akunId            String            // Akun yang terlibat
  
  frekuensi         String            // HARIAN, MINGGUAN, BULANAN, TAHUNAN
  hariDalamBulan    Int?              // 1-31 untuk bulanan
  hariDalamMinggu   Int?              // 0-6 untuk mingguan (0=Minggu)
  
  tanggalMulai      DateTime          @default(now())
  tanggalSelesai    DateTime?         // Opsional, jika ada batas waktu
  
  aktif             Boolean           @default(true)
  terakhirDieksekusi DateTime?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("recurring_transaction")
}

// 7. Tabel Template Transaksi: Template untuk quick-add transaksi
model TemplateTransaksi {
  id                String            @id @default(cuid())
  nama              String            // Nama template (misal: "Kopi Starbucks")
  deskripsi         String            // Deskripsi default transaksi
  nominal           Float             // Nominal default
  kategori          String            // Kategori default
  tipeTransaksi     String            // KELUAR atau MASUK
  
  akunId            String            // Akun default yang digunakan
  
  icon              String?           // Icon untuk tampilan (emoji atau lucide icon)
  warna             String?           // Warna untuk identitas visual
  
  usageCount        Int               @default(0) // Berapa kali digunakan
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("template_transaksi")
}

// 8. Tabel Net Worth Snapshot: Menyimpan histori kekayaan bersih
model NetWorthSnapshot {
  id                String            @id @default(cuid())
  tanggal           DateTime          @default(now())
  
  totalAset         Float             // Total aset (Bank + E-Wallet + Cash)
  totalHutang       Float             // Total hutang (Kartu Kredit negatif + Cicilan)
  netWorth          Float             // Aset - Hutang
  
  // Breakdown per tipe akun
  breakdown         String?           // JSON: {"BANK": 1000000, "E_WALLET": 500000, ...}
  
  createdAt         DateTime          @default(now())

  @@map("net_worth_snapshot")
}

// 9. Tabel Currency Rate: Untuk multi-currency support
model CurrencyRate {
  id                String            @id @default(cuid())
  kodeAsal          String            // Contoh: "USD", "EUR", "SGD"
  kodeTujuan        String            @default("IDR") // Default ke Rupiah
  rate              Float             // 1 USD = 15500 IDR
  
  tanggalUpdate     DateTime          @default(now())
  sumber            String?           // "manual" atau "api"
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([kodeAsal, kodeTujuan])
  @@map("currency_rate")
}

// 10. Tabel App Settings: Pengaturan aplikasi global
model AppSetting {
  id                String            @id @default(cuid())
  kunci             String            @unique // Contoh: "default_currency", "net_worth_tracking"
  nilai             String            // Nilai setting (bisa JSON)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@map("app_setting")
}
